# MAX98367A éŸ³é‡å¢ç›Šä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

MAX98367A ç»„ä»¶ç°å·²æ”¯æŒè½¯ä»¶éŸ³é‡å¢ç›Šæ§åˆ¶ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜ç¡¬ä»¶çš„æƒ…å†µä¸‹è°ƒæ•´éŸ³é¢‘è¾“å‡ºéŸ³é‡ã€‚

## API è¯´æ˜

### 1. è®¾ç½®éŸ³é‡å¢ç›Š
```c
void max98367a_set_gain(float gain);
```
- **å‚æ•°**: `gain` - å¢ç›Šå€¼ï¼ŒèŒƒå›´ 0.0 ~ 2.0
  - `0.0` = é™éŸ³
  - `0.5` = åŠéŸ³é‡
  - `1.0` = åŸéŸ³é‡ï¼ˆé»˜è®¤ï¼‰
  - `1.5` = 1.5å€éŸ³é‡
  - `2.0` = 2å€éŸ³é‡
- **è¯´æ˜**: è¶…å‡ºèŒƒå›´çš„å€¼ä¼šè¢«è‡ªåŠ¨é™åˆ¶åœ¨ 0.0~2.0 ä¹‹é—´

### 2. è·å–å½“å‰å¢ç›Š
```c
float max98367a_get_gain(void);
```
- **è¿”å›**: å½“å‰çš„å¢ç›Šå€¼

### 3. åº”ç”¨å¢ç›Šåˆ°éŸ³é¢‘æ•°æ®
```c
void max98367a_apply_gain(void *data, size_t len);
```
- **å‚æ•°**: 
  - `data` - éŸ³é¢‘æ•°æ®ç¼“å†²åŒºï¼ˆint32_tæ•°ç»„ï¼‰
  - `len` - æ•°æ®é•¿åº¦ï¼ˆå­—èŠ‚æ•°ï¼‰
- **è¯´æ˜**: é€šå¸¸åœ¨éŸ³é¢‘å¤„ç†ä»»åŠ¡ä¸­è°ƒç”¨ï¼Œè‡ªåŠ¨åº”ç”¨å½“å‰å¢ç›Šè®¾ç½®

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åœ¨ app_main ä¸­è®¾ç½®åˆå§‹éŸ³é‡
```c
void app_main(void)
{
    app_init();

    // è®¾ç½®ä¸º 1.5 å€éŸ³é‡
    max98367a_set_gain(1.5f);

    // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
}
```

### ç¤ºä¾‹ 2: åŠ¨æ€è°ƒæ•´éŸ³é‡
```c
// å¢å¤§éŸ³é‡
void increase_volume(void)
{
    float current = max98367a_get_gain();
    max98367a_set_gain(current + 0.1f);
}

// å‡å°éŸ³é‡
void decrease_volume(void)
{
    float current = max98367a_get_gain();
    max98367a_set_gain(current - 0.1f);
}

// é™éŸ³
void mute(void)
{
    max98367a_set_gain(0.0f);
}

// æ¢å¤åŸéŸ³é‡
void unmute(void)
{
    max98367a_set_gain(1.0f);
}
```

### ç¤ºä¾‹ 3: åœ¨éŸ³é¢‘å¤„ç†ä»»åŠ¡ä¸­åº”ç”¨å¢ç›Š
```c
void i2s_read_send_task(void *pvParameters)
{
    uint8_t buf[BUF_SIZE];
    size_t bytes_read = 0;
    size_t bytes_written = 0;
 
    while (1) 
    {
        if (i2s_channel_read(rx_handle, buf, BUF_SIZE, &bytes_read, 100) == ESP_OK)
        {
            // åº”ç”¨éŸ³é‡å¢ç›Š
            max98367a_apply_gain(buf, bytes_read);
            
            // å†™å…¥æ’­æ”¾
            i2s_channel_write(tx_handle, buf, bytes_read, &bytes_written, 100);
        }
    }
}
```

### ç¤ºä¾‹ 4: é€šè¿‡ WebSocket è¿œç¨‹æ§åˆ¶éŸ³é‡
```c
void on_ws_message(const char *msg, size_t len)
{
    // å‡è®¾æ¥æ”¶åˆ° JSON: {"cmd":"volume", "gain":1.5}
    if (strstr(msg, "\"cmd\":\"volume\"") != NULL) {
        // è§£æ gain å€¼
        float gain = 1.0f;
        sscanf(msg, "{\"cmd\":\"volume\",\"gain\":%f}", &gain);
        
        // è®¾ç½®éŸ³é‡
        max98367a_set_gain(gain);
        
        ESP_LOGI("WS", "Volume set to: %.2f", gain);
    }
}
```

## é…ç½®è¯´æ˜

### é»˜è®¤å¢ç›Šå€¼
åœ¨ `MAX98367A.h` ä¸­å¯ä»¥ä¿®æ”¹é»˜è®¤å¢ç›Šï¼š
```c
#ifndef MAX98367A_DEFAULT_GAIN
#define MAX98367A_DEFAULT_GAIN    1.0f  // ä¿®æ”¹æ­¤å€¼æ”¹å˜é»˜è®¤éŸ³é‡
#endif
```

## æ€§èƒ½è¯´æ˜

### è®¡ç®—å¼€é”€
- å¢ç›Šä¸º 1.0 æ—¶ï¼Œè‡ªåŠ¨è·³è¿‡è®¡ç®—ï¼Œ**æ— æ€§èƒ½æŸè€—**
- å¢ç›Šé 1.0 æ—¶ï¼Œæ¯ä¸ªé‡‡æ ·ç‚¹éœ€è¦ä¸€æ¬¡ä¹˜æ³•å’Œç§»ä½è¿ç®—
- åœ¨ ESP32-S3 @ 240MHz ä¸‹ï¼Œå¤„ç† 2048 å­—èŠ‚ï¼ˆ512ä¸ªé‡‡æ ·ç‚¹ï¼‰çº¦éœ€ **50 å¾®ç§’**

### éŸ³è´¨å½±å“
- å¢ç›Š < 1.0ï¼šé™ä½éŸ³é‡ï¼Œä¸ä¼šäº§ç”Ÿå¤±çœŸ
- å¢ç›Š = 1.0ï¼šæ— æŸé€ä¼ 
- å¢ç›Š > 1.0ï¼šæé«˜éŸ³é‡ï¼Œå¯èƒ½åœ¨ä¿¡å·å¼ºåº¦é«˜æ—¶äº§ç”Ÿå‰Šæ³¢å¤±çœŸï¼ˆå·²åšæº¢å‡ºä¿æŠ¤ï¼‰

## æŠ€æœ¯ç»†èŠ‚

### å¢ç›Šç®—æ³•
```c
output = input Ã— gain
```

ä¸ºé¿å…æµ®ç‚¹è¿ç®—ï¼Œå®é™…ä½¿ç”¨å®šç‚¹æ•°å®ç°ï¼š
```c
temp = (sample Ã— (gain Ã— 256)) >> 8
```

### æº¢å‡ºä¿æŠ¤
å½“éŸ³é¢‘ä¿¡å· Ã— å¢ç›Š > INT32_MAX æ—¶ï¼Œè‡ªåŠ¨é™å¹…åˆ° INT32_MAXï¼Œé˜²æ­¢å¤±çœŸçˆ†éŸ³ã€‚

## æ³¨æ„äº‹é¡¹

1. **å¢ç›Šè®¾ç½®æ˜¯å…¨å±€çš„**ï¼Œå½±å“æ‰€æœ‰é€šè¿‡ MAX98367A æ’­æ”¾çš„éŸ³é¢‘
2. **çº¿ç¨‹å®‰å…¨**ï¼šå¢ç›Šå€¼æ˜¯ç®€å•çš„ float å˜é‡ï¼Œå¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹å¯èƒ½å­˜åœ¨ç«äº‰
3. **å®æ—¶è°ƒæ•´**ï¼šå¯ä»¥åœ¨ä»»ä½•æ—¶å€™è°ƒç”¨ `max98367a_set_gain()`ï¼Œç«‹å³ç”Ÿæ•ˆ
4. **åŠŸè€—å½±å“**ï¼šå¢ç›Šè®¡ç®—ä¼šç•¥å¾®å¢åŠ  CPU è´Ÿè½½ï¼Œä½†å½±å“å¾ˆå°

## å…¸å‹åº”ç”¨åœºæ™¯

- ğŸ”Š ç”¨æˆ·éŸ³é‡æ§åˆ¶
- ğŸšï¸ è‡ªåŠ¨å¢ç›Šæ§åˆ¶ï¼ˆAGCï¼‰
- ğŸ”‡ å¿«é€Ÿé™éŸ³åŠŸèƒ½
- ğŸ“± è¿œç¨‹éŸ³é‡è°ƒèŠ‚
- ğŸµ éŸ³é¢‘æ·¡å…¥æ·¡å‡ºæ•ˆæœ

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šè®¾ç½®å¢ç›Šåæ— æ•ˆæœ
- æ£€æŸ¥æ˜¯å¦åœ¨éŸ³é¢‘ä»»åŠ¡ä¸­è°ƒç”¨äº† `max98367a_apply_gain()`
- ç¡®è®¤å¢ç›Šå€¼ä¸æ˜¯ 1.0ï¼ˆ1.0 æ—¶è‡ªåŠ¨è·³è¿‡å¤„ç†ï¼‰

### é—®é¢˜ï¼šéŸ³é‡è¿‡å¤§äº§ç”Ÿç ´éŸ³
- é™ä½å¢ç›Šå€¼åˆ° 1.5 ä»¥ä¸‹
- æ£€æŸ¥è¾“å…¥éŸ³é¢‘æ˜¯å¦æœ¬èº«å°±å¾ˆå¤§

### é—®é¢˜ï¼šéŸ³é‡è¿‡å°å¬ä¸è§
- å¢å¤§å¢ç›Šå€¼åˆ° 1.5 ~ 2.0
- æ£€æŸ¥ç¡¬ä»¶è¿æ¥å’Œéº¦å…‹é£çµæ•åº¦

## ç‰ˆæœ¬ä¿¡æ¯

- **æ·»åŠ æ—¥æœŸ**: 2025-11-10
- **ç‰ˆæœ¬**: v1.0
- **å…¼å®¹æ€§**: ESP-IDF v5.4.2+
